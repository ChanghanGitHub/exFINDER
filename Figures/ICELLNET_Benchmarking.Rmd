---
title: "ICELLNET_Benchmarking"
author: "Changhan"
date: "2023-02-13"
output: html_document
---

## Load the required libraries
```{r message=FALSE,warning=FALSE}
library(exFINDER)
library(Seurat)
library(ggplot2)
library(patchwork)
library(RColorBrewer)
library(dplyr)
library(pheatmap)
library(ggraph)

library(BiocGenerics)
library("org.Hs.eg.db")
library("hgu133plus2.db")
library(jetset)
library(icellnet)
library(gridExtra)

db=as.data.frame(read.csv(curl::curl(url="https://raw.githubusercontent.com/soumelis-lab/ICELLNET/master/data/ICELLNETdb.tsv"), sep="\t",header = T, check.names=FALSE, stringsAsFactors = FALSE, na.strings = ""))
               
db.name.couple=name.lr.couple(db, type="Family")
head(db.name.couple)
```


## Part I: Load and process human skin dataset

The processed data (Seurat object) can be downloaded from: https://figshare.com/s/e5b9f3700ee967a26523 
```{r}
library(forcats)

# the dataset can be downloaded using the following link: 
load(url("https://ndownloader.figshare.com/files/25950872"))

# change the labels to portable format
data_humanSkin$meta$labels <- fct_collapse(data_humanSkin$meta$labels, "APOE+FIB"="APOE+ FIB", 
                                           "CD40LG+TC"="CD40LG+ TC",
                                           "COL11A1+FIB"="COL11A1+ FIB",
                                           "FBN1+FIB"="FBN1+ FIB",
                                           "Inflam.DC"="Inflam. DC",
                                           "Inflam.FIB"="Inflam. FIB",
                                           "Inflam.TC"="Inflam. TC")

# creat Seurat object
Data_human <- CreateSeuratObject(data_humanSkin$data, project = "SeuratProject", assay = "RNA",
  min.cells = 0, min.features = 0, names.field = 1,
  names.delim = "_", meta.data = data_humanSkin$meta)

# Seperate two conditions (here we only use one condition)
Data_human <- Data_human[, Data_human@meta.data$condition %in% c("LS")]

# Normalize the data
Data_human <- NormalizeData(Data_human)

# Scale the data
all.genes <- rownames(Data_human)
Data_human <- ScaleData(Data_human, features = all.genes)
```



## Part II: Discover marker genes of each cell population group

We use the processed data (Seurat object) to discover marker genes of all cell groups.
```{r}
Data1 <- Data_human
Data1@meta.data$Type <- as.factor(Data1@meta.data$labels)
Data1 = UpdateSeuratObject(object = Data1)
```


```{r}
data <- as.data.frame(GetAssayData(Data1, slot = "data")) #or other matrix for which features expression values # are scaled by the total expression in each cell

target <- Data1@meta.data
target$Class=Data1$Type
target$Cell=rownames(target)

average.manual=matrix(ncol=length(unique(target$Type)), nrow=length(rownames(data)))
colnames(average.manual)=unique(target$Type)
rownames(average.manual)=rownames(data)
dim(average.manual)
for (cell in unique(target$Type)){
  cells.clust=target$Cell[which(target$Type==cell)]
  average.manual[,cell]=apply(data[,which(colnames(data)%in%cells.clust)], 1, mean)
}

average.clean=average.manual
```



```{r}
# Type: "LC", "cDC2", "FBN1+FIB", "APOE+FIB"
# Group1: LC -> others
# Group2: cDC2 -> others
# Group3: FBN1+FIB -> others
# Group4: APOE+FIB -> others

Type <- c("LC", "cDC2", "FBN1+FIB", "APOE+FIB")

data.icell=as.data.frame(gene.scaling(as.data.frame(average.clean), n=1, db=db))

PC.data=as.data.frame(data.icell[,c("APOE+FIB", "LC", "cDC2", "FBN1+FIB", "Symbol")], row.names = rownames(data.icell))

PC.target=data.frame("Class"=c("APOE+FIB", "LC", "cDC2", "FBN1+FIB"), 
                     "ID"= c("APOE+FIB", "LC", "cDC2", "FBN1+FIB"), 
                     "Cell_type"=c("APOE+FIB", "LC", "cDC2", "FBN1+FIB"))

rownames(PC.target)=c("APOE+FIB", "LC", "cDC2", "FBN1+FIB")
my.selection=c("APOE+FIB", "LC", "cDC2", "FBN1+FIB")

lr_pairs <- list()
for (i in 1:4) {
  score.computation.1= icellnet.score(direction="out", PC.data=PC.data, 
                                    CC.data= as.data.frame(data.icell[,Type[i]], row.names = rownames(data.icell)),  
                                    PC.target = PC.target, PC=my.selection, CC.type = "RNAseq", 
                                    PC.type = "RNAseq",  db = db)
  score1=as.data.frame(score.computation.1[[1]])
  lr1=score.computation.1[[2]]
  # communication from Type[i] to c("LC", "cDC2", "FBN1+FIB", "APOE+FIB")
  lr_pairs[[i]] <- lr1
}

```



```{r}
library(stringr)

Group1_ligands <- list() # ligands from type4
i <- 1

  for (j in 1:4) {
    lr_data <- data.frame(lr_name = rownames(lr_pairs[[i]]), value = lr_pairs[[i]][, j]) 
    lr_data <- lr_data[complete.cases(lr_data$value) & (lr_data$value>0), ]
    
    text <- lr_data$lr_name
    text <- gsub(" ", "", text, fixed=TRUE)
    text <- str_split(text, fixed("/"))
    n <- length(text)
    text_ligands <- c()
    
    for (k in 1:n) {
      text_ligands <- c(text_ligands, text[[k]][1])
    }
    
    text_ligands = text_ligands[!duplicated(text_ligands)]
    text_ligands <- str_split(text_ligands, fixed("+"))
    
    list_ligands <- c()
    for (k in 1:length(text_ligands)) {
      if (length(text_ligands[[k]]) == 1){
      list_ligands <- c(list_ligands, text_ligands[[k]])
      }else{ list_ligands <- c(list_ligands, text_ligands[[k]][1:length(text_ligands[[k]])]) }
    }
    
    Group1_ligands[[j]] <- list_ligands # ligands from i targeting j
  }
```


```{r}
Group2_ligands <- list() # ligands from type4
i <- 2

  for (j in 1:4) {
    lr_data <- data.frame(lr_name = rownames(lr_pairs[[i]]), value = lr_pairs[[i]][, j]) 
    lr_data <- lr_data[complete.cases(lr_data$value) & (lr_data$value>0), ]
    
    text <- lr_data$lr_name
    text <- gsub(" ", "", text, fixed=TRUE)
    text <- str_split(text, fixed("/"))
    n <- length(text)
    text_ligands <- c()
    
    for (k in 1:n) {
      text_ligands <- c(text_ligands, text[[k]][1])
    }
    
    text_ligands = text_ligands[!duplicated(text_ligands)]
    text_ligands <- str_split(text_ligands, fixed("+"))
    
    list_ligands <- c()
    for (k in 1:length(text_ligands)) {
      if (length(text_ligands[[k]]) == 1){
      list_ligands <- c(list_ligands, text_ligands[[k]])
      }else{ list_ligands <- c(list_ligands, text_ligands[[k]][1:length(text_ligands[[k]])]) }
    }
    
    Group2_ligands[[j]] <- list_ligands # ligands from i targeting j
  }
```


```{r}
Group3_ligands <- list() # ligands from type4
i <- 3

  for (j in 1:4) {
    lr_data <- data.frame(lr_name = rownames(lr_pairs[[i]]), value = lr_pairs[[i]][, j]) 
    lr_data <- lr_data[complete.cases(lr_data$value) & (lr_data$value>0), ]
    
    text <- lr_data$lr_name
    text <- gsub(" ", "", text, fixed=TRUE)
    text <- str_split(text, fixed("/"))
    n <- length(text)
    text_ligands <- c()
    
    for (k in 1:n) {
      text_ligands <- c(text_ligands, text[[k]][1])
    }
    
    text_ligands = text_ligands[!duplicated(text_ligands)]
    text_ligands <- str_split(text_ligands, fixed("+"))
    
    list_ligands <- c()
    for (k in 1:length(text_ligands)) {
      if (length(text_ligands[[k]]) == 1){
      list_ligands <- c(list_ligands, text_ligands[[k]])
      }else{ list_ligands <- c(list_ligands, text_ligands[[k]][1:length(text_ligands[[k]])]) }
    }
    
    Group3_ligands[[j]] <- list_ligands # ligands from i targeting j
  }
```


```{r}
Group4_ligands <- list() # ligands from type4
i <- 4

  for (j in 1:4) {
    lr_data <- data.frame(lr_name = rownames(lr_pairs[[i]]), value = lr_pairs[[i]][, j]) 
    lr_data <- lr_data[complete.cases(lr_data$value) & (lr_data$value>0), ]
    
    text <- lr_data$lr_name
    text <- gsub(" ", "", text, fixed=TRUE)
    text <- str_split(text, fixed("/"))
    n <- length(text)
    text_ligands <- c()
    
    for (k in 1:n) {
      text_ligands <- c(text_ligands, text[[k]][1])
    }
    
    text_ligands = text_ligands[!duplicated(text_ligands)]
    text_ligands <- str_split(text_ligands, fixed("+"))
    
    list_ligands <- c()
    for (k in 1:length(text_ligands)) {
      if (length(text_ligands[[k]]) == 1){
      list_ligands <- c(list_ligands, text_ligands[[k]])
      }else{ list_ligands <- c(list_ligands, text_ligands[[k]][1:length(text_ligands[[k]])]) }
    }
    
    Group4_ligands[[j]] <- list_ligands # ligands from i targeting j
  }
```


```{r}
# L_Type_1[[5]]: ligands from all four groups targeting type1
# L_Type_1[[1]]: ligands from type1 targeting type1
# L_Type_1[[2]]: ligands from type2 targeting type1

L_Type <- list()
ICN_ligand <- list()
for (i in 1:4) {
  
  L_Type[[5+5*(i-1)]] <- c(Group1_ligands[[i]], Group2_ligands[[i]], Group3_ligands[[i]], Group4_ligands[[i]])
  L_Type[[5+5*(i-1)]] = L_Type[[5+5*(i-1)]][!duplicated(L_Type[[5+5*(i-1)]])]
  
  L_Type[[1+5*(i-1)]] <- setdiff(L_Type[[5+5*(i-1)]], c(Group2_ligands[[i]], Group3_ligands[[i]], Group4_ligands[[i]]))
  L_Type[[2+5*(i-1)]] <- setdiff(L_Type[[5+5*(i-1)]], c(Group1_ligands[[i]], Group3_ligands[[i]], Group4_ligands[[i]]))
  L_Type[[3+5*(i-1)]] <- setdiff(L_Type[[5+5*(i-1)]], c(Group1_ligands[[i]], Group2_ligands[[i]], Group3_ligands[[i]]))
  L_Type[[4+5*(i-1)]] <- setdiff(L_Type[[5+5*(i-1)]], c(Group1_ligands[[i]], Group2_ligands[[i]], Group4_ligands[[i]]))

}
ICN_ligand <- L_Type
```


## Benchmarking part 2: exFINDER analysis
```{r}
# load exFINDER database
load("../data/LR_layer1_human.rda")
load("../data/RTF_layer2_human.rda")
load("../data/TFT_layer3_human.rda")

exFINDER.H <- list()
exFINDER.H[[1]] <- LR_layer1_human
exFINDER.H[[2]] <- RTF_layer2_human
exFINDER.H[[3]] <- TFT_layer3_human
```


Generate 5 datasets for the analysis.
```{r}
data = data_humanSkin$data # normalized data matrix
meta = data_humanSkin$meta # a dataframe with rownames containing cell mata data

# no "LC" cells
cell.use1 = rownames(meta)[meta$condition == "LS" & meta$labels %in% c("cDC2", "FBN1+FIB", "APOE+FIB")]
# no "cDC2" cells
cell.use2 = rownames(meta)[meta$condition == "LS" & meta$labels %in% c("LC", "FBN1+FIB", "APOE+FIB")]
# no "FBN1+ FIB" cells
cell.use3 = rownames(meta)[meta$condition == "LS" & meta$labels %in% c("LC", "cDC2", "APOE+FIB")]
# no "APOE+ FIB" cells
cell.use4 = rownames(meta)[meta$condition == "LS" & meta$labels %in% c("LC", "cDC2", "FBN1+FIB")]
# All four cell groups
cell.use5 = rownames(meta)[meta$condition == "LS" & meta$labels %in% c("LC", "cDC2", "FBN1+FIB", "APOE+FIB")]

barcode <- mget(paste0('cell.use', 1:5))
```


```{r}
# setup input data
exp.data <- Data1@assays$RNA@data
meta.data <- Data1@meta.data
```


```{r}
cell_type <- c("LC", "cDC2", "FBN1+FIB", "APOE+FIB")
exF_ligand <- list()
# barcode <- mget(paste0('cell.use', 1:5))

for (k in 1:4) {
  # top 10 marker genes of cell_type[k]
  marker <- read.csv(file = paste("../markers/He2020_Human_marker/He2020_Human_markers_",cell_type[k],".csv",sep=""))
  marker_list <- marker$X[1:10]
  
  ltGRN <- get_ltGRN(Target = marker_list, DB = exFINDER.H)
  # infer all ligands that are measured in the scRNA-seq data
  exS_0 <- get_potentialex(Graph = ltGRN,
                Exp.Data = exp.data,
                Meta.Data = meta.data,
                cutoff = 0,
                AG.L = c("LC", "cDC2", "FBN1+FIB", "APOE+FIB")) # ligands can come from any of the four cell groups
  exF_ligand[[5 + 5*(k-1)]] <- exS_0
  
  for (i in 1:4) {
    # select cells of dataset i
    data.input = exp.data[, barcode[[i]]]
    meta.input = data.frame(Type = meta.data[barcode[[i]], ]$Type)
    meta.input$Type <- fct_drop(meta.input$Type)
    rownames(meta.input) <- barcode[[i]]
    
    # infer ligands that not highly expressed in dataset i  
    # (so they may be highly expressed by the cells outside dataset i)
    exS_1 <- get_potentialex(Graph = ltGRN,
                Exp.Data = data.input,
                Meta.Data = meta.input,
                cutoff = -0.8,
                AG.L = NULL)
    
    exF_ligand[[i + 5*(k-1)]] <- exS_1
  }
  
}
```


By comparing the results, we can calculate the recovery rate -- the proportion of the ICELLNET-inferred ligands that captured by exFINDER.
```{r}
coverR <- c()

for (j in 1:length(exF_ligand)) {
  # if CellChat does not find such ligands, then we set "cover rate"=NULL
  if ( length(ICN_ligand[[j]])==0 ){
    coverR[j] <- "NULL"
  } else{
    coverR[j] <- 1- length(setdiff(ICN_ligand[[j]], exF_ligand[[j]]))/length(ICN_ligand[[j]])
  }
}


coverR[coverR == "NULL"] <- NaN
coverR <- as.numeric(coverR)

df <- data.frame("LC" = coverR[1:5], "cDC2" = coverR[6:10], 
                  "FBN1+ FIB" = coverR[11:15], "APOE+ FIB" = coverR[16:20])
rownames(df) <- c("LC-specific", "cDC2-specific", "FBN1+ FIB-specific", "APOE+ FIB-specific", "All cell groups")
df
```



```{r, fig.width=5,fig.height = 4, fig.wide = TRUE, fig.align = "center"}
bk <- c(seq(0,0.59,by=0.01), seq(0.6,1,by=0.01))

p <- pheatmap(t(df),
         cluster_row = FALSE, cluster_cols = FALSE, 
         cellwidth = 40, cellheight = 40,
         fontsize_row = 12,
         fontsize_col = 10,
         angle_col = 45,
         color = c(colorRampPalette(colors = c("blue","white"))(length(bk)/2),colorRampPalette(colors = c("white","red"))(length(bk)/2)),
         breaks=bk)
p
# ggsave(p, filename="Heatmap_Human_ICELLNET_exFINDER.pdf")
```


